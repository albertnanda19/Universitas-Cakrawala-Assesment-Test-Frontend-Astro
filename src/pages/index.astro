---
import { client } from "../lib/graphql/client";
import { GET_PAGINATED_ARTICLES } from "../lib/graphql/queries";
import ArticleList from "../components/ArticleList.astro";
import Layout from "../layouts/Layout.astro";
import Seo from "../components/Seo.astro";

export const prerender = false;

const url = Astro.url;
const pageParam = url.searchParams.get("page") || "1";
const pageNum = parseInt(pageParam, 10);
const page = Number.isFinite(pageNum) && pageNum > 0 ? pageNum : 1;
const pageSize = 3;
const sort = ["publishedAt:desc"];
const { articles } = await client.request(GET_PAGINATED_ARTICLES, {
  page,
  pageSize,
  sort,
});
const pagedArticles = Array.isArray(articles) ? articles : [];
const hasPrev = page > 1;
const hasNext = Array.isArray(articles) && articles.length === pageSize;
---

<Layout>
  <Fragment slot="head">
    <Seo
      title="Universitas Cakrawala - News Portal"
      description="Latest articles and updates from Universitas Cakrawala."
      ogType="website"
    />
  </Fragment>

  <h1 class="text-3xl font-bold py-6">Latest Articles</h1>

  <ArticleList articles={pagedArticles} hrefBase="/" showExcerpt={true} />

  <nav class="py-6 flex items-center justify-between">
    {
      hasPrev ? (
        <a
          href={`/?page=${page - 1}`}
          class="px-4 py-2 border rounded bg-white hover:bg-gray-100"
          rel="prev"
        >
          Prev
        </a>
      ) : (
        <span class="px-4 py-2 text-gray-400 border rounded bg-gray-100">
          Prev
        </span>
      )
    }

    <span class="text-sm text-gray-600">Page {page}</span>

    {
      hasNext ? (
        <a
          href={`/?page=${page + 1}`}
          class="px-4 py-2 border rounded bg-white hover:bg-gray-100"
          rel="next"
        >
          Next
        </a>
      ) : (
        <span class="px-4 py-2 text-gray-400 border rounded bg-gray-100">
          Next
        </span>
      )
    }
  </nav>
</Layout>
